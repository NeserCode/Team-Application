<template>
  <div class="localSetting">
    <SettingOption
      opTitle="⚠开发者模式"
      opType="switch"
      :opBindValue="true"
      opTip="开启此选项以获得开发者功能权限"
      :opDisabled="true"
    />
    <SettingOption
      :opTitle="appOnTop.title"
      opType="switch"
      :opTip="appOnTop.tip"
      :opBindValue="appOnTop.value"
      :opCallbackFn="appOnTop.fn"
    />
    <SettingOption
      :opTitle="appCloseAction.title"
      opType="switch"
      :opTip="appCloseAction.tip"
      :opBindValue="appCloseAction.value"
      :opCallbackFn="appCloseAction.fn"
    />
    <SettingOption
      :opTitle="appTheme.title"
      opType="touch"
      :opTip="appTheme.tip"
      :opTouchArray="appTheme.array"
      :opTouchValue="appTheme.value"
    />
    <SettingOption
      :opTitle="appHostDomain.title"
      opType="input"
      :opTip="appHostDomain.tip"
      opExtraValue="serverDomain"
      opInputPlaceholder="Domain Here"
      :opDisabled="false"
      :opBindValue="appHostDomain.value"
      @settingInput="domainInput"
      @opChange="handleDomainChange"
    />
    <SettingOption
      :opTitle="appHostPort.title"
      opType="input"
      :opTip="appHostPort.tip"
      opExtraValue="serverPort"
      opInputPlaceholder="Port Here"
      :opDisabled="false"
      :opBindValue="appHostPort.value"
      @settingInput="portInput"
      @opChange="handlePortChange"
    />
  </div>
</template>

<script>
import SettingOption from "@/components/Setting/option/index.vue";
const { ipcRenderer } = window.require("electron");

export default {
  name: "LocalSetting",
  components: { SettingOption },
  data() {
    return {
      isClickable: true,
      appOnTop: {
        title: "窗口前置",
        value: false,
        fn: this.handleChangeAppOnTop,
        tip: "开启此选项将本软件页面置于图层最前方",
      },
      appCloseAction: {
        title: "关闭选项",
        value: true,
        fn: this.handleChangeCloseAction,
        tip: "决定点击关闭按钮后应用是最小化还是彻底退出，默认不勾选为直接退出",
      },
      appTheme: {
        title: "主题",
        value: "system",
        array: [
          {
            id: 0,
            value: "light",
            choice: "☀ 日间主题",
            fn: () => {
              this.handleChangeAppTheme("light");
            },
          },
          {
            id: 1,
            value: "dark",
            choice: "🌙 夜间主题",
            fn: () => {
              this.handleChangeAppTheme("dark");
            },
          },
          {
            id: 2,
            value: "system",
            choice: "❤ 跟随系统",
            fn: () => {
              this.handleChangeAppTheme("system");
            },
          },
        ],
        tip: "选择色彩主题以应对视觉疲劳和损伤",
      },
      appHostDomain: {
        title: "服务器主机地址",
        value: "127.0.0.1",
        tip: "服务器的主机名即域名或者IP 不需要协议与端口 例如:127.0.0.1",
      },
      appHostPort: {
        title: "服务器端口",
        value: "5999",
        tip: "服务器运行服务的端口 例如:5999",
      },
      settings: null,
    };
  },
  mounted() {
    this.$conf.getConfPromise().then((data) => {
      this.settings = data.data;
      this.appOnTop.value = this.settings.userSetting.alwaysOnTop;
      this.appCloseAction.value = this.settings.userSetting.alwaysCloseDirect;
      this.appTheme.value = this.settings.userSetting.colorSchemeMode;
    });
  },
  methods: {
    domainInput: function (temp) {
      this.appHostDomain.value = temp;
    },
    portInput: function (temp) {
      this.appHostPort = temp;
    },
    handleDomainChange: function (e) {
      console.log(e);
    },
    handlePortChange: function (e) {
      console.log(e);
    },
    handleChangeAppOnTop: function () {
      if (this.isClickable) {
        this.isClickable = false;
        this.appOnTop.value = !this.appOnTop.value;

        if (this.appOnTop.value) ipcRenderer.send("setting-always-on-top");
        else ipcRenderer.send("setting-always-not-top");
        this.settings.userSetting.alwaysOnTop = this.appOnTop.value;
        this.handleChangeSettingAction();
      }
    },
    handleChangeCloseAction: function () {
      if (this.isClickable) {
        this.isClickable = false;
        this.appCloseAction.value = !this.appCloseAction.value;
        if (this.appCloseAction.value)
          this.$public.emit("update-header-need-close-direct", true);
        else this.$public.emit("update-header-need-close-direct", false);
        this.settings.userSetting.alwaysCloseDirect = this.appCloseAction.value;
        this.handleChangeSettingAction();
      }
    },
    handleChangeAppTheme: function (theme) {
      if (this.isClickable) {
        this.isClickable = false;
        this.appTheme.value = theme;
        ipcRenderer.send("color-schemeMode-" + theme);
        this.settings.userSetting.colorSchemeMode = this.appTheme.value;
        this.handleChangeSettingAction();
      }
    },
    handleChangeSettingProcess: function (err) {
      if (err)
        this.$public.emit("notice", {
          title: "保存时出现了一个错误",
          msg: err,
          type: "error",
          fn: () => {
            this.isClickable = true;
          },
        });
      else {
        this.$public.emit("notice", {
          title: "",
          msg: "设置保存成功 正在为您启用设置",
          type: "success",
          fn: () => {
            this.isClickable = true;
          },
        });
      }
    },
    handleChangeSettingAction: function () {
      this.$conf.updateLocalConfig(this.settings, (err) => {
        this.handleChangeSettingProcess(err);
      });
    },
  },
};
</script>

<style scoped lang="postcss">
.localSetting {
  @apply py-8;
}

@media (prefers-color-scheme: dark) {
}

@media (prefers-color-scheme: light) {
}
</style>